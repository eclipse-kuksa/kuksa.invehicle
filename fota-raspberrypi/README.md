# FOTA Raspberry Pi

The fota scripts are used by the kuksa-appmanager to flash firmware images to the Raspberry Pi.
Details on the interaction with the appmanager can be found in [kuksa-appmanager/wiki/fota.md](https://github.com/eclipse/kuksa.invehicle/blob/master/kuksa-appmanager/wiki/fota.md).

### kuksa-firmware-flash
When called, expects one line of JSON via stdin, containing the firmware name, version and files.
Currently only one file is supported which must be a firmware OS image.

### kuksa-firmware-get-version
Expects a firmware name as argument and prints a version to stdout.
Currently the only supported firmware name is *osimage* (name of the software module in hawkbit).
For this it returns the version the version of the currently installed OS according to /etc/os-release.

## Preliminaries
The SD card has to have three partitions:

1. boot partition
2. rootfs partition A
3. rootfs partition B

Only one rootfs partitions is active at a time.
When a new firmware is flashed, it is flashed to the inactive partition and the bootloader configuration is updated to switch to the other partition.

When the meta-kuksa-bsp layer is used, the AGL image for the Raspberry Pi will contain these three partitions, with partition A active and partition B inactive and empty.

## Firmware OS image
The firmware has to consist of exactly one file.
It must be an image containing a boot partition and a rootfs partition.
Two file types are supported:

* uncompressed .img file
* compressed .xz file (highly recommended)

The images generated by the yocto build process for AGL can be used directly.

## Rollback functionality
The U-Boot bootloader already provides basic rollback functionalities, which have to be activated in the image build process.
To be able to control the boot loader settings the tools `fw_setenv` and `fw_printenv` must be installed.
It is highly recommended to install these fota scripts with the AGL recipes from the `meta-kuksa-bsp` layer to make sure these conditions are met.

After flashing the firmware we set the bootloader configuration `upgrade_available` to 1.
In this mode, the bootloader counts the attempted boots and when a preset bootlimit is reached, it runs an alternative boot sequence.
The alternative boot sequence performs a rollback by switching back to the other partition.

After a system upgrade the script `kuksa-upgrade-verification.sh` resets the configuration `upgrade_available` back to 0 to avoid an unintended rollback.
Optionally, a self check of the system can be performed first, to make sure it is working as intended.
If the file `/usr/bin/kuksa-selfcheck` exists, it will be run and in case of a failure, indicated by a nonzero return value, the system will reboot to perform a rollback.

